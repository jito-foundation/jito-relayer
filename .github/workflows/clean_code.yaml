name: Clean Code Check
on:
  workflow_call:
    secrets:
      GHUB_TOKEN:
        required: true
      ACCESS_TOKEN:
        required: true
jobs:
  clippy_and_udeps_check:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v2
      # https://github.com/actions/checkout/issues/116#issuecomment-573880976
      # Very hacky, but tells .gitmodules to pull from HTTPS instead of SSH
      - name: Checkout submodules using a PAT
        run: |
          git config --file .gitmodules --get-regexp url | while read url; do
          git config --file=.gitmodules $(echo "$url" | sed -E "s/org-87542516@github.com:|https:\/\/github.com\//https:\/\/${{ secrets.ACCESS_TOKEN }}:${{ secrets.ACCESS_TOKEN }}@github.com\//")
          done
          git submodule sync
          git submodule update --init --recursive
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          components: clippy
      - uses: actions-rs/clippy-check@v1
        with:
          token: ${{ secrets.GHUB_TOKEN }}
          args: --all-features
# TODO: add this back, but at the moment it requires +nightly to run which breaks from Solana deps
#      - uses: actions-rs/cargo@v1
#        with:
#          command: install
#          args: cargo-udeps --locked
#      - name: cargo udeps
#        uses: actions-rs/cargo@v1
#        with:
#          command: udeps
